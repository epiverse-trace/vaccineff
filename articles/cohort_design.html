<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to cohort design with vaccineff • vaccineff</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to cohort design with vaccineff">
<!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ471458FQ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ471458FQ');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">
    <a href="https://epiverse-trace.github.io/" class="external-link"><img src="https://epiverse-trace.github.io/blueprints/logo_white.svg" id="logo" alt="Epiverse-TRACE"></a>
    <a class="navbar-brand me-2" href="../index.html">vaccineff</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/vaccineff.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cohort_design.html">Introduction to cohort design with vaccineff</a></li>
    <li><a class="dropdown-item" href="../articles/other_designs.html">Other study designs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epiverse-trace/vaccineff/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to cohort design with vaccineff</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epiverse-trace/vaccineff/blob/main/vignettes/cohort_design.Rmd" class="external-link"><code>vignettes/cohort_design.Rmd</code></a></small>
      <div class="d-none name"><code>cohort_design.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/epiverse-trace/vaccineff" class="external-link">vaccineff</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="cohort-design">Cohort Design<a class="anchor" aria-label="anchor" href="#cohort-design"></a>
</h2>
<p>In cohort studies, vaccine effectiveness
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>E</mi></mrow><annotation encoding="application/x-tex">VE</annotation></semantics></math>)
is calculated after following vaccinated and unvaccinated individuals
over time. However, VE may depend on individual characteristics (e.g.,
age and sex) and external factors (e.g., environment, number of doses,
virus strain, and calendar period). Typically, VE is estimated in open
or dynamic cohorts, where individuals can enter or leave the cohort at
any time after the initial study date and change their vaccination
status. Thus,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>E</mi></mrow><annotation encoding="application/x-tex">VE</annotation></semantics></math>
can be estimated by survival analysis methods, substituting the relative
risk for the hazard ratio
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">HR</annotation></semantics></math>),
which considers the person-time at risk in the estimation of VE <span class="citation">(<a href="#ref-bookvaccine">Halloran, Longini, and
Struchiner 2010</a>)</span>. <code>Vaccineff</code> package estimates VE
using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>H</mi><mi>R</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mn>100</mn><mi>%</mi></mrow><annotation encoding="application/x-tex">(1-HR) \times 100\%</annotation></semantics></math>
and therefore, the outcome variable is the time from the initial study
date to the occurrence of the event (e.g., infection, death,
hospitalization) or the date of the end of the study. VE is approximated
by the Cox proportional hazards model that is usually written by the
following expression:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>e</mi><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>p</mi></munderover><msub><mi>β</mi><mi>i</mi></msub><msub><mi>X</mi><mi>i</mi></msub></mrow></msup><mo>,</mo></mrow><annotation encoding="application/x-tex">\begin{equation}\label{eq:cox}
h(t,X)=h_0(t) e ^{\sum_{i=1}^p \beta_i X_i},
\end{equation}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t, X)</annotation></semantics></math>
is the risk function for each individual over the time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
given a set of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
explanatory/predictors variables denoted by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
(e.g., vaccination status, age, sex).
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_0 (t)</annotation></semantics></math>
represents the baseline hazard function when all variables of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
are equal to 0. In the Cox regression model, it is unnecessary to
specify
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_0 (t)</annotation></semantics></math>,
making this type of analysis a semiparametric model. Finally, the
interest of the analysis is to compare the risk function of two
individuals according to the values of the explanatory variables, which
is achieved through the estimated coefficients of the model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>β</mi><mo accent="true">̂</mo></mover><mi>j</mi></msub><annotation encoding="application/x-tex">\hat \beta_j</annotation></semantics></math>
(Equation 1) and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">HR</annotation></semantics></math>.
For example, if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mn>1</mn></msub><annotation encoding="application/x-tex">X_1</annotation></semantics></math>
is the vaccination status where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">X_1=1</annotation></semantics></math>
denotes the vaccinated group and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">X_1=0</annotation></semantics></math>
denotes the unvaccinated group without including other predictors, the
HR corresponds to:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>R</mi><mo>=</mo><mfrac><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>e</mi><mrow><msub><mi>β</mi><mn>1</mn></msub><msub><mi>X</mi><mn>1</mn></msub><mo stretchy="false" form="prefix">|</mo><mi>X</mi><mo>=</mo><mn>1</mn></mrow></msup></mrow><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>e</mi><mrow><msub><mover><mi>β</mi><mo accent="true">̂</mo></mover><mn>1</mn></msub><msub><mi>X</mi><mn>1</mn></msub><mo stretchy="false" form="prefix">|</mo><mi>X</mi><mo>=</mo><mn>0</mn></mrow></msup></mrow></mfrac><mo>=</mo><msup><mi>e</mi><msub><mover><mi>β</mi><mo accent="true">̂</mo></mover><mn>1</mn></msub></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mi>e</mi><msub><mover><mi>β</mi><mo accent="true">̂</mo></mover><mn>1</mn></msub></msup><mo>,</mo></mrow><annotation encoding="application/x-tex">HR=\frac{h_0(t) e ^{ \beta_1 X_1|X=1}}{h_0(t) e ^{ \hat \beta_1 X_1|X=0}}=e^{ \hat \beta_1} (1-0)=e^{ \hat \beta_1},</annotation></semantics></math></p>
<p>therefore, the estimated
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">HR</annotation></semantics></math>
does not depend on time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_0 (t)</annotation></semantics></math>
can remain unspecified, assuming that the effect of an explanatory
variable is proportional over time representing <em>the proportional
hazard (PH) assumption</em>. When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>R</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">HR&lt;1</annotation></semantics></math>
indicates a reduction in the risk of an event of interest over time and
the context of VE, it will be the expected outcome. <em>Vaccineff</em>
uses the Schoenfeld residual test to determine whether the global PH
assumption of the model is violated.</p>
<p>When working with observational data, other potential factors or
baseline characteristics besides vaccination status could explain the
observed differences in the risk of the event (e.g., death, reinfection)
between vaccinated and unvaccinated individuals. <code>Vaccineff</code>
allows the estimation of VE with and without running a <em>iterative
matching process (IMP)</em> to emulate the balance achieved by a trial
design on potential confounders without involving the calendar period
which implies that the disease incidence has not changed during the
study period.</p>
<p><code>vaccineff</code> package uses the number of days elapsed from
the vaccine administration to the occurrence of the event to measure the
length of follow-up.</p>
<p><img src="https://raw.githubusercontent.com/epiverse-trace/vaccineff/main/inst/images/follow-up-unmatched.png" class="rmarkdown-img" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;" align="center" width="560"></p>
<div class="section level3">
<h3 id="estimating-ve-without-iterative-matching-process">Estimating VE without iterative matching process<a class="anchor" aria-label="anchor" href="#estimating-ve-without-iterative-matching-process"></a>
</h3>
<p><code>vaccineff</code> performs the conventional estimation of VE
based on the Cox regression model using the option
<code>match=FALSE</code> in <code>make_vaccineff_data</code> function.
This is the simplest possible model, as it does not take into account
that VE can be affected by possible confounding factors, such as age or
sex. To begin the analysis, the first step is to transform the original
data into a <code>vaccineff</code> data by
<code>make_vaccineff_data</code> function and declare the names of
variables containing relevant information such as the date of outcome or
event occurs <code>outcome_date_col</code> or the censoring date
<code>censoring_date_col</code>, date of last dose
<code>vacc_date_col</code>, labels to identify vaccinated
<code>vaccinated_status</code> and unvaccinated groups
<code>unvaccinated_status</code>, and the date of last follow up of the
cohort <code>end_cohort</code>. The <code>censoring_date_col</code>
option should be used if the study end date varies for some subjects
because an event other than the study outcome has occurred, for example,
when a subject dies from causes other than the disease of interest.</p>
<p>The crude VE (unadjusted) is then estimated and the survival curves
can also be visualized by the following code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"cohortdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create `vaccineff_data`</span></span>
<span><span class="va">vaccineff_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_vaccineff_data.html">make_vaccineff_data</a></span><span class="op">(</span></span>
<span>  data_set <span class="op">=</span> <span class="va">cohortdata</span>,</span>
<span>  outcome_date_col <span class="op">=</span> <span class="st">"death_date"</span>,</span>
<span>  censoring_date_col <span class="op">=</span> <span class="st">"death_other_causes"</span>,</span>
<span>  vacc_date_col <span class="op">=</span> <span class="st">"vaccine_date_2"</span>,</span>
<span>  vaccinated_status <span class="op">=</span> <span class="st">"v"</span>,</span>
<span>  unvaccinated_status <span class="op">=</span> <span class="st">"u"</span>,</span>
<span>  immunization_delay <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  end_cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-31"</span><span class="op">)</span>,</span>
<span>  match <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the Vaccinef Effectiveness (VE)</span></span>
<span><span class="va">ve1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_vaccineff.html">estimate_vaccineff</a></span><span class="op">(</span><span class="va">vaccineff_data</span>, at <span class="op">=</span> <span class="fl">180</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print summary of VE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ve1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Vaccine Effectiveness at 180 days computed as VE = 1 - HR:</span></span>
<span><span class="co">#&gt;      VE lower.95 upper.95</span></span>
<span><span class="co">#&gt;  0.8809   0.8235   0.9197</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Schoenfeld test for Proportional Hazards assumption:</span></span>
<span><span class="co">#&gt; p-value = 6e-04</span></span>
<span><span class="co">#&gt; Warning:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; p-value &lt; 0.05. Please check loglog plot for Proportional Hazards assumption</span></span>
<span></span>
<span><span class="co"># Generate Survival plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve1</span>, type <span class="op">=</span> <span class="st">"surv"</span>, percentage <span class="op">=</span> <span class="cn">FALSE</span>, cumulative <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="cohort_design_files/figure-html/artcohor-1.png" width="768"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Generate loglog plot to check proportional hazards</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve1</span>, type <span class="op">=</span> <span class="st">"loglog"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cohort_design_files/figure-html/artcohor-2.png" width="768"></p>
<p>The crude VE of death from two doses was 68.9% [95% CI 54.6-78.7].
Furthermore, since the log-log plot shows that the curves do not appear
entirely parallel, this indicates that there is a slight violation of
the proportional assumption, which in many data sets can be resolved
after adjusting for possible confounding factors.</p>
</div>
<div class="section level3">
<h3 id="estimating-ve-with-iterative-matching-process">Estimating VE with iterative matching process<a class="anchor" aria-label="anchor" href="#estimating-ve-with-iterative-matching-process"></a>
</h3>
<p><code>vaccineff</code> performs an IMP after the end of the study by
dividing the cohort between those who were never vaccinated and those
who received the vaccine at some point during follow-up. This method
should be seen as an attempt to control for potential confounders that
could influence the vaccine status as well as the occurrence of the
interesting event. IMP selects pairs of unvaccinated and vaccinated
individuals with similar characteristics (potential confounders, e.g.,
age, sex), making the groups comparable on important confounders
variables, as shown in the figure below:</p>
<p><img src="https://raw.githubusercontent.com/epiverse-trace/vaccineff/main/inst/images/static_matching.png" class="rmarkdown-img" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;" align="center" width="560"></p>
<p>IMP runs a nearest neighbor matching using Mahalanobis distance to
analyze similarities between a pair of unvaccinated and vaccinated
subjects as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>d</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo>,</mo><mi>v</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>u</mi></msub><mo>−</mo><msub><mi>x</mi><mi>v</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>T</mi></msup><msup><mi>Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>u</mi></msub><mo>−</mo><msub><mi>x</mi><mi>v</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">d^2 (u,v)=(x_u-x_v)^T \Sigma^{-1} (x_u-x_v),</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
corresponds to values of confounders variables y
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Σ</mi><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math>
is the sample variance-covariance matrix to standardize the variables.
Thus, IMP selects the unvaccinated individual with the shortest distance
for each person in the vaccinated group. However, all these pairings are
provisional because the IMP procedure checks for each pairing that the
matched unvaccinated individual has not developed the outcome (e.g.,
death) before the immunization date of the vaccinated partner. This
point is important because the follow-up start date for both subjects
corresponds to the immunization date of the vaccinated subject plus the
number of days required for the vaccine to have a protective effect:</p>
<p><img src="https://raw.githubusercontent.com/epiverse-trace/vaccineff/main/inst/images/follow-up-matched.png" class="rmarkdown-img" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;" align="center" width="560"></p>
<p>For this reason, the algorithm iterates until the largest number of
matched pairs with equivalent exposure time is obtained. At the end of
the procedure, unvaccinated and vaccinated individuals who cannot be
matched are eliminated from the analysis. The estimation of VE with IMP
using <code>vaccineff</code> is performed using a Cox regression model
with a robust variance estimator to account for the clustering within
matched pairs <span class="citation">Austin (<a href="#ref-austin2014use">2014</a>)</span>. In our example, we decided
to control for age and sex using the options <code>match=TRUE</code> and
<code>exact = c("age", "sex")</code> in the
<code>make_vaccineff_data</code> function. Now, this function creates a
set of matched data, look at the new dataset using
<code>vaccineff_data_matched[["matching"]]$match</code>.</p>
<p>When the <code>exact</code> option is used, the IMP searches for each
case, a control with the same characteristics. In our example, the IMP
matches pairs of the exact same sex and age. If an exact match is not
required, a <code>nearest</code> option is also available to match
similar but not identical pairs. This option could make possible to
match pairs with a caliper or distance of 1 on age (e.g., case of 49
years with a control of 50 years). Note also that both options can be
used simultaneously for the IMP process.</p>
<p>The following code block estimates a VE using IMP matching only
considering the <code>exact</code> option.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"cohortdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create `vaccineff_data`</span></span>
<span><span class="va">vaccineff_data_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_vaccineff_data.html">make_vaccineff_data</a></span><span class="op">(</span></span>
<span>  data_set <span class="op">=</span> <span class="va">cohortdata</span>,</span>
<span>  outcome_date_col <span class="op">=</span> <span class="st">"death_date"</span>,</span>
<span>  censoring_date_col <span class="op">=</span> <span class="st">"death_other_causes"</span>,</span>
<span>  vacc_date_col <span class="op">=</span> <span class="st">"vaccine_date_2"</span>,</span>
<span>  vaccinated_status <span class="op">=</span> <span class="st">"v"</span>,</span>
<span>  unvaccinated_status <span class="op">=</span> <span class="st">"u"</span>,</span>
<span>  immunization_delay <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  end_cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-31"</span><span class="op">)</span>,</span>
<span>  match <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  exact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span>,</span>
<span>  nearest <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If the <code>summary</code> function is applied to a vaccineff
object, a report of exact IMP is displayed.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">vaccineff_data_matched</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cohort start:  2021-03-26</span></span>
<span><span class="co">#&gt; Cohort end:  2021-12-31</span></span>
<span><span class="co">#&gt; The start date of the cohort was defined as the mininimum immunization date. </span></span>
<span><span class="co">#&gt; 65 registers were removed with outcomes before the start date.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Nearest neighbors matching iteratively performed.</span></span>
<span><span class="co">#&gt; Number of iterations:  4</span></span>
<span><span class="co">#&gt; Balance all:</span></span>
<span><span class="co">#&gt;               u         v         smd</span></span>
<span><span class="co">#&gt; age   63.917069 62.997438 -0.08593156</span></span>
<span><span class="co">#&gt; sex_F  0.520277  0.573474  0.10701746</span></span>
<span><span class="co">#&gt; sex_M  0.479723  0.426526 -0.10701746</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance matched:</span></span>
<span><span class="co">#&gt;               u         v smd</span></span>
<span><span class="co">#&gt; age   63.751784 63.751784   0</span></span>
<span><span class="co">#&gt; sex_F  0.521457  0.521457   0</span></span>
<span><span class="co">#&gt; sex_M  0.478543  0.478543   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary vaccination:</span></span>
<span><span class="co">#&gt;               u     v</span></span>
<span><span class="co">#&gt; All       10973 19905</span></span>
<span><span class="co">#&gt; Matched   10789 10789</span></span>
<span><span class="co">#&gt; Unmatched   184  9116</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; // tags: outcome_date_col:death_date, censoring_date_col:death_other_causes, vacc_date_col:vaccine_date_2, immunization_date_col:immunization_date, vacc_status_col:vaccine_status</span></span></code></pre></div>
<p>In the output of <code>vaccineff_data_matched</code>, the user can
check the differences between the unmatched and matched cohorts using
standardized mean difference (SMD) to measure the distance between the
unvaccinated and vaccinated individuals. In our example, SMD for age and
sex is 0 because an exact IMP was run, see the results in the balance
matched output. The number of unmatched individuals (removed) from the
analysis is also reported. In this example, out of a total of 62743
unvaccinated individuals and 37257 vaccinated individuals, the IMP
procedure was able to match 27612 pairs considering the characteristics
of the individuals and the time of exposure. Now, using
<code>the vaccineff_data_matched</code> object in the
<code>estimate_vaccineff</code> function, the VE is estimated.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate the Vaccinef Effectiveness (VE)</span></span>
<span><span class="va">ve2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_vaccineff.html">estimate_vaccineff</a></span><span class="op">(</span><span class="va">vaccineff_data_matched</span>, at <span class="op">=</span> <span class="fl">180</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print summary of VE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ve2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Vaccine Effectiveness at 180 days computed as VE = 1 - HR:</span></span>
<span><span class="co">#&gt;      VE lower.95 upper.95</span></span>
<span><span class="co">#&gt;  0.6778    0.473    0.803</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Schoenfeld test for Proportional Hazards assumption:</span></span>
<span><span class="co">#&gt; p-value = 0.0192</span></span>
<span><span class="co">#&gt; Warning:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; p-value &lt; 0.05. Please check loglog plot for Proportional Hazards assumption</span></span>
<span></span>
<span><span class="co"># Generate loglog plot to check proportional hazards</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve2</span>, type <span class="op">=</span> <span class="st">"loglog"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cohort_design_files/figure-html/artcohor3-1.png" width="768"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Generate Survival plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve2</span>, type <span class="op">=</span> <span class="st">"surv"</span>, percentage <span class="op">=</span> <span class="cn">FALSE</span>, cumulative <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="cohort_design_files/figure-html/artcohor3-2.png" width="768"></p>
<p>In the matched cohort, the estimated VE for death of two doses was
66.7% [95% CI 46.1–79.4]. Although, Schoenfeld test was rejected (p
value&lt;0.05), the log-log plot demonstrates that the proportional
hazards assumption was not violated, as they appear quite parallel
compared to the crude log-log output.</p>
<p>Finally, to compare the effect of a IMP matching on the VE estimation
using a caliper of 2 on age and the exact sex, the following code can be
implemented:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"cohortdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create `vaccineff_data`</span></span>
<span><span class="va">vaccineff_data_matched2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_vaccineff_data.html">make_vaccineff_data</a></span><span class="op">(</span></span>
<span>  data_set <span class="op">=</span> <span class="va">cohortdata</span>,</span>
<span>  outcome_date_col <span class="op">=</span> <span class="st">"death_date"</span>,</span>
<span>  censoring_date_col <span class="op">=</span> <span class="st">"death_other_causes"</span>,</span>
<span>  vacc_date_col <span class="op">=</span> <span class="st">"vaccine_date_2"</span>,</span>
<span>  vaccinated_status <span class="op">=</span> <span class="st">"v"</span>,</span>
<span>  unvaccinated_status <span class="op">=</span> <span class="st">"u"</span>,</span>
<span>  immunization_delay <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  end_cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-31"</span><span class="op">)</span>,</span>
<span>  match <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  exact <span class="op">=</span> <span class="st">"sex"</span>,</span>
<span>  nearest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">vaccineff_data_matched2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cohort start:  2021-03-26</span></span>
<span><span class="co">#&gt; Cohort end:  2021-12-31</span></span>
<span><span class="co">#&gt; The start date of the cohort was defined as the mininimum immunization date. </span></span>
<span><span class="co">#&gt; 65 registers were removed with outcomes before the start date.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Nearest neighbors matching iteratively performed.</span></span>
<span><span class="co">#&gt; Number of iterations:  3</span></span>
<span><span class="co">#&gt; Balance all:</span></span>
<span><span class="co">#&gt;               u         v         smd</span></span>
<span><span class="co">#&gt; age   63.917069 62.997438 -0.08593156</span></span>
<span><span class="co">#&gt; sex_F  0.520277  0.573474  0.10701746</span></span>
<span><span class="co">#&gt; sex_M  0.479723  0.426526 -0.10701746</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance matched:</span></span>
<span><span class="co">#&gt;                u          v         smd</span></span>
<span><span class="co">#&gt; age   63.8914428 63.5114927 -0.03493039</span></span>
<span><span class="co">#&gt; sex_F  0.5205391  0.5205391  0.00000000</span></span>
<span><span class="co">#&gt; sex_M  0.4794609  0.4794609  0.00000000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary vaccination:</span></span>
<span><span class="co">#&gt;               u     v</span></span>
<span><span class="co">#&gt; All       10973 19905</span></span>
<span><span class="co">#&gt; Matched   10833 10833</span></span>
<span><span class="co">#&gt; Unmatched   140  9072</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; // tags: outcome_date_col:death_date, censoring_date_col:death_other_causes, vacc_date_col:vaccine_date_2, immunization_date_col:immunization_date, vacc_status_col:vaccine_status</span></span>
<span></span>
<span></span>
<span><span class="co"># Estimate the Vaccinef Effectiveness (VE)</span></span>
<span><span class="va">ve3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_vaccineff.html">estimate_vaccineff</a></span><span class="op">(</span><span class="va">vaccineff_data_matched2</span>, at <span class="op">=</span> <span class="fl">180</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print summary of VE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ve3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Vaccine Effectiveness at 180 days computed as VE = 1 - HR:</span></span>
<span><span class="co">#&gt;      VE lower.95 upper.95</span></span>
<span><span class="co">#&gt;  0.6883    0.485   0.8113</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Schoenfeld test for Proportional Hazards assumption:</span></span>
<span><span class="co">#&gt; p-value = 0.0751</span></span>
<span></span>
<span><span class="co"># Generate loglog plot to check proportional hazards</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve3</span>, type <span class="op">=</span> <span class="st">"loglog"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cohort_design_files/figure-html/artcohor4-1.png" width="768"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Generate Survival plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve3</span>, type <span class="op">=</span> <span class="st">"surv"</span>, percentage <span class="op">=</span> <span class="cn">FALSE</span>, cumulative <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="cohort_design_files/figure-html/artcohor4-2.png" width="768"></p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-austin2014use" class="csl-entry">
Austin, Peter C. 2014. <span>“The Use of Propensity Score Methods with
Survival or Time-to-Event Outcomes: Reporting Measures of Effect Similar
to Those Used in Randomized Experiments.”</span> <em>Statistics in
Medicine</em> 33 (7): 1242–58.
</div>
<div id="ref-bookvaccine" class="csl-entry">
Halloran, Elizabeth, Ira Longini, and Claudio Struchiner. 2010.
<em>Design and Analysis of Vaccine Studies</em>. Springer.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Santiago Quevedo, Zulma M. Cucunubá, International Development Research Center (IDRC).</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3. Theme provided by <a href="https://github.com/epiverse-trace/epiversetheme" class="external-link">epiversetheme</a> 0.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
